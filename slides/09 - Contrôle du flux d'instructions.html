<!doctype html>
<html lang="fr">

	<head>
		<meta charset="utf-8">

		<title>Cours javascript : contrôle du flux d'instructions</title>

		<meta name="description" content="cours de javascript">
		<meta name="author" content="Yannick Bochatay">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
        <link rel="stylesheet" href="css/theme/simple.css" id="theme">
        <link rel="stylesheet" href="css/custom.css">

        <!-- For syntax highlighting -->
        <link rel="stylesheet" href="lib/css/vs.css">

		<!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
        window.print();
			}
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Javascript</h1>
					<h3>Contrôle du flux d'instructions</h3>
				</section>
				<section>
					<h2>Bloc</h2>
					<p>L'instruction la plus simple est l'instruction de bloc qui permet de regrouper des instructions. Un bloc est délimité par une paire d'accolades.</p>
					<p>Les instructions de blocs sont souvent utilisées avec les instructions conditionnelles et itératives telles que <code>if, for, while</code>.</p>
					<pre><code>while (x < 10) {
  x++;
}</code></pre>

				</section>
				<section>
					<h2>Instructions conditionnelles</h2>
					</section>
				<section>
					<section>
						<h2>Instruction if...else</h2>
						<pre><code class="javascript">if (condition) {
  //code exécuté si condition est évalué à true
}</code></pre>
				<pre><code class="javascript">if (condition) {
  //instruction1;
} else {
  //instruction2;
}</code></pre>
				<pre><code class="javascript">if (condition1) {
  //instruction1;
} else if (condition2){
  //instruction2;
} else {
  //instruction3;
}
</code></pre>
<p>Si la condition n'est pas un booléen, la conversion est automatique.</p>
					</section>

				</section>

				<section>
					<h2>Opérateur conditionnel ternaire</h2>
					<p>Syntaxe</p>
					<code class="syntaxe">condition ? expr1 : expr2 </code>
					<br/>
					<p>Exemples</p>
					<pre><code class="javascript">let autorisation = true;

console.log( autorisation ? "autorisé" : "interdit" ); //autorisé</code></pre>
<pre><code class="javascript">let toto = { nom : "Toto", age : 25};

console.log( toto.age > 18 ? "majeur" : "mineur" ); //majeur</code></pre>
				</section>

				<section>
					<h2>Valeurs équivalentes à false</h2>
					<p>Lors d'une conversion en booléen, les valeurs suivantes renvoient false (falsy values) :</p>
					<ul>
					 <li><code>false</code></li>
					 <li><code>undefined</code></li>
					 <li><code>null</code></li>
					 <li><code>0</code></li>
					 <li><code>NaN</code></li>
					 <li><code>""</code></li>
					</ul>
					<p>Les autres valeurs, dont les objets, renvoient true.</p>
					<pre><code>Boolean(5); //true
Boolean(-1); //true
Boolean(0); //false
Boolean({}); //true
Boolean([]); //true
Boolean(5/0); // Infinity => true
Boolean( Number("toto") ); // NaN => false
Boolean("true"); //true
Boolean("false"); //true</code></pre>
				</section>

				<section>
					<section>
						<h2>Instruction switch</h2>
						<p>Syntaxe</p>
						<code class="syntaxe">switch (expression) {<br/>
	&nbsp;&nbsp;case label_1: instructions_1 [break;]<br/>
	&nbsp;&nbsp;case label_2: instructions_2 [break;]<br/>
	&nbsp;&nbsp;...<br/>
	&nbsp;&nbsp;default: instructions_par_defaut [break;]<br/>
	}</code>
	<br/>
	<p>Exemple</p>
						<pre><code class="javascript">function prixDesFruits(fruits) {

  let prix;

  switch (fruits) {
    case "Oranges" : prix = 0.59; break;
    case "Cerises" : prix = 3; break;
    case "Mangues" : case "Papayes" : prix = 2.79; break;
    default: console.log("Désolé, nous n'avons pas de " + fruits + ".");
  }

  return prix;
}</code></pre>
				</section>
				<section>
					<h2>Instruction switch</h2>
					<p>C'est l'égalité <u>stricte</u> qui est testée.</p>
					<p>Attention à ne pas oublier le <code>break</code> sans quoi toutes les instructions qui suivent seront également exécutées (c'est le mécanisme qui permet de regrouper les cas).</p>
				</section>
			</section>

				<section>
					<h2>Boucles et itération</h2>
				</section>
				<section>
                    <h2>Instruction for</h2>
                    <p>Syntaxe</p>
                    <code class="syntaxe">
                        for ([expressionInitiale]; [condition]; [expressionIncrément])
                        <br/>
                        &nbsp;&nbsp;instruction
                    </code>
                    <br/><br/>
                    <p>
                    Exemple
                    <pre><code class="javascript">for (let pas=0 ; pas<5 ; pas++) {
  // Ceci sera exécuté 5 fois
  // la variable "pas" ira de 0 à 4
  console.log("Faire un pas vers l'est");
}
						</code></pre>
						</p>

				</section>

				<section>

						<h2>Instruction while</h2>
						<p>Syntaxe</p>
						<code class="syntaxe">while (condition)
						  instruction;
						</code>
						<p>ou</p>
						<code class="syntaxe">
						do
						  instruction
						while (condition);</code>
						<br/>
						<p>Dans le deuxième cas, l'instruction sera exécutée au moins une fois, même si la condition est fausse.</p>
						<br/>
						<p>Exemple</p>
						<pre><code class="javascript">let n = 0;
let x = 0;

while (n < 3) {
  n++;
  x+= n;
}</code></pre>

				</section>

				<section>
					<section>
          <h2>Instruction for...in</h2>
					<p>Itération sur les propriétés énumérables d'un objet.</p>
					<p>Syntaxe</p>
          <code class="syntaxe">for (variable in objet) instruction</code>
          <br/>
					<p>Exemple</p>
					<pre><code class="javascript">function afficherProps(obj) {
  let result = "";
  for (let n in obj) result += `${n} = ${obj[n]} \n`;
  return result;
}

afficherProps({nom:"Toto",age:25});
/*
nom=Toto
age=25
*/
</code></pre>
					</section>
					<section>
						<h2>Instruction for...in</h2>
						<ul>
							<li>parcourt les propriétés d'un objet dans un ordre <u>arbitraire</u></li>
							<li>ne doit pas être utilisé pour parcourir un tableau</li>
							<li>ne parcourt que les propriétés énumérables</li>
						</ul>
					</section>
        </section>

        <section>
					<section>
					<h2>Instruction for...of</h2>
					<p>Boucle sur les valeurs des itérables (tableaux, chaînes, listes, etc)</p>
					<p>Syntaxe</p>
          <code class="syntaxe">for (variable of iterable) instruction</code>
          <br/>
					<p>Exemple</p>
					<pre><code class="javascript">function enumere(obj) {
  let result = ""
  for (let value of obj) result += value + ";";
  return result;
}

enumere([1, 2, 3]);
// 1;2;3;

enumere("toto");
// t;o;t;o;
</code></pre>
          </section>
          <section>
						<h2>Instruction for...of</h2>
						<ul>
              <li>ne fonctionne que sur les objets itérables</li>
              <li>parcourt les propriétés de manière ordonnée</li>
							<li>affecte la valeur à la variable et non la clé</li>
						</ul>
					</section>
        </section>


				<section>
					<h2>break</h2>
					<p>Provoque la fin de l'instruction <code>while, do-while, for,</code> ou <code>switch</code> dans laquelle il est inscrit (la plus imbriquée).</p>
					<br/><pre><code class="javascript">let tab = ["toto","titi","tata"];

for (let i=0; i&lt;tab.length; i++) {
  if (a[i] == "tata") break;
  console.log(a[i]);
}
</code></pre>
				</section>
				<section>
					<h2>continue</h2>
					<p>Termine l'itération courante de la boucle (la plus imbriquée) et passe à l'exécution de la prochaine itération.</p>
					<br/><pre><code class="javascript">let i = 0;
let n = 0;

while (i < 5) {
  i++;
  if (i == 3) continue;
  n += i;
}

n; //1 + 2 + 4 + 5</code></pre>
				</section>

				<section>
					<h2>Gestion des exceptions</h2>
				</section>

				<section>
					<h2>Gestion des exceptions</h2>
					<h3>Problème</h3>
					<pre><code class="javascript">function dernierElement(tableau) {

  if (tableau.length === 0) {
    console.log("Le tableau est vide");
    return false;
  }

  return tableau.at(-1);
}
					</code></pre>
<p>Ce code n'est pas très bon pour plusieurs raisons</p>
<ul>
	<li class="fragment">comment faire si je veux informer l'utilisateur que le tableau est vide, autrement que par la console ?</li>
	<li class="fragment">Que se passe-t-il si le dernier élément du tableau contient la valeur <code>false</code> ?</li>
</ul>
				</section>

				<section>
					<h2>Gestion des exceptions</h2>
					<h3>Solution</h3>
					<p>La fonction jette (ou lève) une exception quand elle rencontre un cas anormal.</p>
					<pre><code class="javascript">function dernierElement(tableau) {

  if (tableau.length === 0) throw new Error("Le tableau est vide");

  return tableau.at(-1);
}</code></pre>
					<p>C'est à l'appel de la fonction que l'on décide comment gérer l'erreur.</p>
					<pre><code class="javascript">try { dernierElement([]); }
catch(e) { console.log(e); }

//ou

try { dernierElement([]); }
catch(e) { window.alert(e); }</code></pre>
				</section>

				<section>
					<!-- <section> -->
					<h2>Gestion des exceptions</h2>
					<h3>Exemple complet</h3>
					<pre style="width:100%"><code class="javascript" style="max-height:1000px">function verifNom(nom) {
  if (typeof nom !== "string") throw new Error(typeof nom + ": type incorrect");
  if ( !/^[a-z]+$/i.test(nom) ) throw new Error(nom + ": nom incorrect");
}

function verifAge(age) {
  if (typeof age !== "number") throw new Error(typeof age + ": type incorrect");
  if (age < 0 || age > 120) throw new Error(age + ": âge incorrect");
}

function verifChamps(obj) {
  if (typeof obj !== "object") throw new Error("verifChamps attend un objet");
  verifNom(obj.nom);
  verifAge(obj.age);
}

try {
    verifChamps({ nom : "Toto", age : 25 });
    verifChamps({ nom : "Toto" });
    verifChamps({ nom : 25, age : "Toto" });
}
catch(e) { window.alert(e); }</code></pre>
					</section>

					<!-- <section>
					<h2>Gestion des exceptions</h2>
					<h3>Exemple plus poussé</h3>
					<pre style="width:100%"><code class="javascript" style="max-height:1000px">function verifNom(nom) {
  if (typeof nom != "string") throw new TypeError(typeof nom + ": type incorrect");
  if ( !/^[a-z]+$/i.test(nom) ) throw new SyntaxError(nom + ": nom incorrect");
}

function verifAge(age) {
  if (typeof age != "number") throw new TypeError(typeof age + ": type incorrect");
  if (age < 0 || age > 120) throw new RangeError(age + ": âge incorrect");
}

function verifChamps(obj) {
  if (typeof obj != "object") throw new TypeError("verifChamps attend un objet");
  verifNom(obj.nom);
  verifAge(obj.age);
}

try {
    verifChamps({ nom : "Toto", age : 25 });
    verifChamps({ nom : "Toto" });
    verifChamps({ nom : 25, age : "Toto" });
}
catch(e) {
    if (e instanceof TypeError) console.log("ça s'adresse plutôt au programmeur");
    else window.alert("ça s'adresse plutôt à l'utilisateur");
}</code></pre>
					</section> -->

				<!-- 	<section>
						<h2>Gestion des exceptions</h2>
						<h3>Remarques</h3>
						<ul>
						<li>Les accolades sont obligatoires même si elles contiennent une instruction unique.</li>
						<li>La variable du bloc <code>catch</code> à une portée de bloc (c'est l'unique cas en ECMAScript 5).</li>
						</ul>
						<pre><code class="javascript" style="max-height:1000px">try {
  throw new Error("grave erreur !");
}
catch(e) {
  console.log(e.message);
  let toto = "toto";
}
toto; //"toto";
e; //Exception : e is not defined;
						</code></pre>
					</section> -->
				<!-- </section> -->

				<section>
					<h2>Asynchronisme</h2>
					<h3>Exemple</h3>
					<pre><code class="javascript">let i=0;

window.setTimeout(() => i++, 1000);

console.log(i); //?</code></pre>
				</section>

				<section>
					<h2>Asynchronisme</h2>
					<h3>évènements</h3>
					<pre><code class="javascript">let img = new Image();

img.src = "http://www.meteofrance.com/vigilance/mn.gif";

console.log(img.width); //0
//car l'image est chargée de manière asynchrone

//mais
img.addEventListener("load", () => console.log(img.width) /* 71 */);

//quand l'image est chargée, l'évènement "load" est déclenché
//et les fonctions liées à l'évènement sont exécutées.
</code></pre>
				</section>

				<section>
					<h2>Asynchronisme</h2>
					<h3>Callback hell</h3>
					<pre><code class="javascript" style="max-height:1000px">//Supposons que nous voulions charger une série d'images,
//les unes après les autres, avec une pause de 5 secondes entre chaque
let img = new Image();
img.src = "http://monServeur/monImage1.png";
img.addEventListener("load", () => {
  window.setTimeout(() => {
    let img = new Image();
    img.src = "http://monServeur/monImage2.png";
    img.addEventListener("load", () => {
      window.setTimeout(() => {
        let img = new Image();
        img.src = "http://monServeur/monImage3.png";
        img.addEventListener("load", () => {
          //etc etc
        });
      },5000);
    });
  },5000);
});</code></pre>
				</section>

				<section>
					<h2>Asynchronisme</h2>
					<h3>Callback hell, tentative d'amélioration</h3>
					<pre><code class="javascript" style="max-height:1000px">function chargerImage(src,callback) {
  let img = new Image();
  img.src = "http://monServeur/"+src;
  img.addEventListener("load", () => window.setTimeout(callback, 5000));
}

chargerImage("monImage1.png", () => {
  chargerImage("monImage2.png", () => {
    chargerImage("monImage3.png", () => {
      //etc etc
    });
  });
});</code></pre>
				</section>

				<section>
          <section>
					<h2>Promesses</h2>
					<pre><code class="javascript" style="max-height:1000px">function chargerImage(src) {
  return new Promise(resolve => {
    let img = new Image();
    img.src = "http://monServeur/"+src;
    img.addEventListener("load", () => resolve(img));
  });
}

function attendre(s) {
  return new Promise(resolve => window.setTimeout(resolve,s*1000));
}

chargerImage("monImage1.png")
.then(() => attendre(5))
.then(() => chargerImage("monImage2.png"))
.then(() => attendre(5))
.then(() => chargerImage("monImage3.png"))
.then(() => attendre(5));</code></pre>
					<a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Guide/Utiliser_les_promesses" target="liens">
						<small>https://developer.mozilla.org/fr/docs/Web/JavaScript/Guide/Utiliser_les_promesses</small>
					</a>
        </section>

        <section>
          <h2>Promesses</h2>
          <h3>Gestion des erreurs</h3>
          <pre><code class="javascript" style="max-height:1000px">function chargerImage(src) {
  return new Promise((resolve, reject) => {
    let img = new Image();
    img.src = "http://monServeur/"+src;
    img.addEventListener("load", () => resolve(img));
    img.addEventListener("error", () => reject(new Error("erreur de chargement")));
  });
}

chargerImage("monImage1.png")
.then(() => attendre(5))
.then(() => chargerImage("monImage2.png"))
.then(() => attendre(5))
// exécuté si une erreur se produit dans un des blocs précédents
.catch(e => console.error(e))
// exécuté dans tous les cas
.then(() => console.log("traitement terminé"));</code></pre>
				</section>
      </section>

				<section>
          <section>
          <h2>Async / await</h2>
          <p>Façon la plus aboutie et la plus claire de gérer l'asynchronisme.</p>
          <pre><code class="javascript" style="max-height:1000px">
async function chargerTout() {
  await chargerImage("monImage1.png");
  await attendre(5);
  await chargerImage("monImage2.png");
  await attendre(5);
  await chargerImage("monImage3.png");
  await attendre(5);
}

chargerTout();</code></pre>
        </section>

        <section>
          <h2>Async / await</h2>
          <h3>Gestion des erreurs</h3>
					<pre><code class="javascript" style="max-height:1000px">
async function chargerTout() {
  try {
    await chargerImage("monImage1.png");
    await attendre(5);
    await chargerImage("monImage2.png");
    await attendre(5);
    await chargerImage("monImage3.png");
    await attendre(5);
  } catch (e) {
    console.error(e);
  }
}

chargerTout();</code></pre>
        </section>
      </section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>
		<script src="js/initialize.js"></script>

	</body>
</html>
